# File Reference Guide - Where to Make Changes

## ğŸ¯ Quick Reference: Where to Update What

### ğŸ“Š Database Models & Schema
**When to update**: Adding new entities, changing table structure, new relationships
```
ğŸ“ backend/app/models.py                    # All SQLModel classes and relationships
ğŸ“ backend/app/alembic/versions/            # Database migration files
ğŸ“ backend/app/core/db.py                   # DB initialization, default data seeding
```

### ğŸ” Authentication & Security
**When to update**: Adding new roles, changing JWT structure, auth logic
```
ğŸ“ backend/app/core/security.py             # JWT creation, password hashing
ğŸ“ backend/app/api/deps.py                  # Auth dependencies, role validation
ğŸ“ backend/app/api/routes/login.py          # Login, password reset, invitation acceptance
```

### ğŸ¢ Multi-Tenant Management
**When to update**: Tenant features, organization management, isolation rules
```
ğŸ“ backend/app/api/routes/tenants.py        # Tenant CRUD operations
ğŸ“ backend/app/api/routes/tenant_users.py   # User management within tenants
ğŸ“ backend/app/api/routes/tenant_credits.py # Tenant credit management
ğŸ“ backend/app/api/routes/tenant_api_keys.py # Tenant API key management
ğŸ“ backend/app/api/routes/tenant_email_config.py # Tenant email settings
```

### ğŸ’³ Subscription & Billing System
**When to update**: New plan features, billing logic, subscription management
```
ğŸ“ backend/app/api/routes/subscriptions.py  # Subscription plans and user subscriptions
ğŸ“ backend/app/services/credit_service.py   # Credit operations and balance calculations
ğŸ“ backend/app/crud.py                      # Subscription-related database operations
```

### ğŸ”‘ API Key Management
**When to update**: New AI providers, key rotation logic, security improvements
```
ğŸ“ backend/app/services/api_key_service.py  # Key encryption, tenant assignment
ğŸ“ backend/app/api/routes/admin_api_keys.py # SuperAdmin key management
ğŸ“ backend/app/api/routes/admin_tenant_api_keys.py # Cross-tenant key viewing
```

### ğŸ¤– AI API Proxy
**When to update**: New AI providers, cost calculation, usage tracking
```
ğŸ“ backend/app/services/ai_api_service.py   # AI API proxy logic, cost calculation
ğŸ“ backend/app/api/routes/ai_proxy.py       # AI API endpoints
```

### ğŸ‘¥ User Invitation System
**When to update**: Invitation flow, email templates, user onboarding
```
ğŸ“ backend/app/services/invitation_service.py # Invitation creation and acceptance
ğŸ“ backend/app/email-templates/src/invitation.mjml # Invitation email template
ğŸ“ backend/app/email-templates/src/welcome.mjml # Welcome email template (if exists)
```

### ğŸ“§ Email System
**When to update**: Email templates, SMTP configuration, email delivery
```
ğŸ“ backend/app/utils.py                     # Email generation and sending functions
ğŸ“ backend/app/email-templates/src/         # MJML source templates
ğŸ“ backend/app/email-templates/build/       # Compiled HTML templates
ğŸ“ backend/app/api/routes/utils.py          # Email testing endpoints
```

### ğŸ‘¤ User Management
**When to update**: User features, profile management, user operations
```
ğŸ“ backend/app/api/routes/users.py          # User CRUD, profile updates, credit balance
ğŸ“ backend/app/crud.py                      # User database operations
```

### ğŸ—ï¸ Application Core
**When to update**: App configuration, startup logic, middleware
```
ğŸ“ backend/app/main.py                      # FastAPI app setup, CORS, middleware
ğŸ“ backend/app/core/config.py               # Environment configuration
ğŸ“ backend/app/api/main.py                  # API router registration
```

## ğŸ“‹ Common Update Scenarios

### Adding New Database Model
1. **Add model class** â†’ `backend/app/models.py`
2. **Add relationships** â†’ Update related models in `backend/app/models.py`
3. **Create migration** â†’ `alembic revision --autogenerate -m "description"`
4. **Run migration** â†’ `alembic upgrade head`
5. **Add CRUD operations** â†’ `backend/app/crud.py`

### Adding New API Endpoint
1. **Create route function** â†’ Appropriate file in `backend/app/api/routes/`
2. **Register router** â†’ `backend/app/api/main.py`
3. **Add dependencies** â†’ Use existing deps from `backend/app/api/deps.py`
4. **Update models** â†’ Add request/response models in `backend/app/models.py`

### Adding New AI Provider
1. **Update API key service** â†’ `backend/app/services/api_key_service.py`
2. **Update AI proxy service** â†’ `backend/app/services/ai_api_service.py`
3. **Add cost calculation** â†’ Update `_calculate_cost()` method
4. **Add new endpoints** â†’ `backend/app/api/routes/ai_proxy.py`

### Adding New User Role
1. **Update TokenPayload** â†’ `backend/app/models.py`
2. **Add role constants** â†’ `backend/app/shared/constants/roles.py`
3. **Update dependencies** â†’ `backend/app/api/deps.py`
4. **Update role checks** â†’ Throughout API route files

### Modifying Email Templates
1. **Edit MJML source** â†’ `backend/app/email-templates/src/*.mjml`
2. **Compile to HTML** â†’ Use MJML extension in VS Code
3. **Save compiled version** â†’ `backend/app/email-templates/build/*.html`
4. **Update template logic** â†’ `backend/app/utils.py`

### Adding New Subscription Feature
1. **Update SubscriptionPlan model** â†’ `backend/app/models.py`
2. **Create migration** â†’ `alembic revision --autogenerate`
3. **Update subscription service** â†’ `backend/app/api/routes/subscriptions.py`
4. **Update credit allocation** â†’ `backend/app/services/credit_service.py`

## ğŸ”§ Configuration Files

### Environment Configuration
```
ğŸ“ .env                                     # Environment variables
ğŸ“ backend/app/core/config.py               # Settings class and validation
```

### Database Configuration
```
ğŸ“ backend/app/core/db.py                   # Database engine and initialization
ğŸ“ backend/app/alembic/env.py               # Alembic migration configuration
ğŸ“ backend/app/alembic/alembic.ini          # Alembic settings
```

### Dependencies & Build
```
ğŸ“ backend/pyproject.toml                   # Python dependencies and project config
ğŸ“ backend/Dockerfile                       # Docker container configuration
ğŸ“ backend/docker-compose.yml               # Local development setup
```

## ğŸ§ª Testing Files

### Test Organization
```
ğŸ“ backend/app/tests/conftest.py            # Test configuration and fixtures
ğŸ“ backend/app/tests/api/routes/            # API endpoint tests
ğŸ“ backend/app/tests/crud/                  # Database operation tests
ğŸ“ backend/app/tests/utils/                 # Test utilities and helpers
```

### Test Utilities
```
ğŸ“ backend/app/tests/utils/user.py          # User creation and auth helpers
ğŸ“ backend/app/tests/utils/item.py          # Item creation helpers
ğŸ“ backend/app/tests/utils/utils.py         # General test utilities
```

## ğŸš€ Deployment & Scripts

### Deployment Scripts
```
ğŸ“ backend/scripts/prestart.sh              # Pre-deployment setup
ğŸ“ backend/scripts/test.sh                  # Run test suite
ğŸ“ backend/scripts/format.sh                # Code formatting
ğŸ“ backend/scripts/lint.sh                  # Code linting
```

### Migration Scripts
```
ğŸ“ backend/app/backend_pre_start.py         # Database connection check
ğŸ“ backend/app/initial_data.py              # Initial data seeding
ğŸ“ backend/app/tests_pre_start.py           # Test database setup
```

## ğŸ¨ Module Structure (Future Organization)

### Planned Module Organization
```
ğŸ“ backend/app/modules/                     # Future modular structure
â”œâ”€â”€ auth/                                   # Authentication module
â”œâ”€â”€ tenants/                                # Tenant management module
â”œâ”€â”€ subscriptions/                          # Billing and subscriptions
â”œâ”€â”€ api_keys/                               # API key management
â”œâ”€â”€ credits/                                # Credit system
â”œâ”€â”€ invitations/                            # User invitation system
â”œâ”€â”€ email/                                  # Email configuration
â”œâ”€â”€ ai_proxy/                               # AI API proxy
â””â”€â”€ items/                                  # Business entities
```

## ğŸ’¡ Quick Tips for Updates

### Before Making Changes
1. **Check current models** â†’ `backend/app/models.py`
2. **Review existing tests** â†’ `backend/app/tests/`
3. **Check dependencies** â†’ `backend/app/api/deps.py`
4. **Review business logic** â†’ Relevant service files

### After Making Changes
1. **Run tests** â†’ `bash backend/scripts/test.sh`
2. **Check linting** â†’ `bash backend/scripts/lint.sh`
3. **Update migrations** â†’ `alembic revision --autogenerate`
4. **Update documentation** â†’ This file and API docs

### Common Gotchas
- **Always update both model and migration** when changing schema
- **Check role-based access** for new endpoints
- **Update tests** when adding new functionality
- **Compile MJML templates** after editing email templates
- **Check tenant isolation** for new multi-tenant features